---
title: 爬取搜索引擎之搜狗
date: 2017-03-19 15:02:35
comments: true
tags: 反爬虫
categories: 技术研究
---
<blockquote class="blockquote-center">听过最落寞的一句话或诗句是什么？
——不如意事常八九，可与言者无二三</blockquote>


上篇讲述了爬取百度搜索结果时遇到的问题以及解决方案，本篇继续爬取搜索引擎的话题，说说爬取搜狗时将会遇到什么问题？以及怎么去解决。搜狗搜索引擎的名气在国内远没有百度那么大，但却称得上是后起之秀，其搜索结果的准确度以及爬虫算法都还不错，可以说搜狗搜索在国内是继百度搜索之外的又一良好选择，想要了解百度搜索相关信息的，可以移步：[爬取搜索引擎之寻你千百度](http://thief.one/2017/03/17/%E7%88%AC%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E%E4%B9%8B%E5%AF%BB%E4%BD%A0%E5%8D%83%E7%99%BE%E5%BA%A6/)

<!--more -->

关于反爬虫的技术，网上有很多资源，方法不外乎（代理、识别验证码、分布式架构、模拟浏览器、ADSL切换ip等），这些不是本文的重点，本文只针对爬取搜狗搜索引擎时遇到的反爬虫措施，以及一些解决方案。


### 为甚么要爬取搜狗

* 搜索结果比较准确比较全，没有类似百度保护资源的措施
* 同样拥有丰富的资源
* 反爬虫措施相对没有那么严格

### 搜狗反爬虫措施

利用爬虫爬取搜狗搜索引擎结果，首先要解决的是cookie的问题。搜狗会验证http请求是否带有cookie参数，如不带cookie那么请求次数将会非常有限。想要解决这一问题，我们必须先弄清楚搜狗搜索引擎cookie内容的组成，以及其作用。

#### cookie内容解析
```bash
Cookie: ABTEST=3|1489908642|v17; IPLOC=CN3301; SUID=899F006F2208990A0000000058CE33A3; SUV=1489908643339695; browerV=3; osV=1; sct=1; SNUID=1B0D93FD9297D882F63E3C8D93692285; ld=E@n5Llllll2Y80nclllllV0nGEklllllbZjKAyllll9lllll9Zlll5@@@@@@@@@@
```
经过我测试，发现其中有2个参数异常重要，也是影响搜索反爬虫措施的关键参数，SUID、SNUID以及SUV。

#### SUID

SUID具体的含义可以自行百度，这里只讲述它生成的过程。当我们访问sogou搜索首页的时候，set-cookies中便会生成一个SUID参数的内容，除非重启浏览器，不然短时间内SUID并不会改变。SUID的值应该是sogou服务端随便分配的，只有当重新开启一个session时它的值才会更新。

#### SNUID

SNUID是sogou反爬虫的重点，sogou也是对同一个SNUID访问次数做了限制，而超过限制后，会跳转到验证码页面，只有输入验证码重新验证以后，SNUID才会更新，访问才能继续进行。那么SNUID是如何生成的呢？经过测试，应该是由javascript生成的，当然前提是要有SUID，SUID是生成SNUID的基础。

#### SUV

SUV参数内容是由javascript生成的，测试并没有发现其对于反爬虫有何影响，故本文不做详细介绍。

### 被屏蔽现象

同样，要解决反爬虫问题，我们先来看看触发反爬虫的现象。
当同一个SNUID访问次数受限后，继续访问sogou会跳转到一个验证码页面，地址：
```bash
http://www.sogou.com/antispider/?from=%2fweb%3Fquery%3d152512wqe%26ie%3dutf8%26_ast%3d1488957312%26_asf%3dnull%26w%3d01029901%26p%3d40040100%26dp%3d1%26cid%3d%26cid%3d%26sut%3d578%26sst0%3d1488957299160%26lkt%3d3%2C1488957298718%2C1488957298893
```
页面源码：
```bash
HTTP/1.1 200 OK
Server: nginx
Date: Thu, 27 Oct 2016 04:41:19 GMT
Content-Type: text/html
Connection: keep-alive
X-Powered-By: PHP/5.3.3
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Content-Length: 5130

<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href="//www.sogou.com/images/logo2014/new/favicon.ico" type="image/x-icon">
    <title>搜狗搜索</title>
    <link rel="stylesheet" href="static/css/anti.min.css?v=1"/>
    <script src="//dl.web.sogoucdn.com/common/lib/jquery/jquery-1.11.0.min.js"></script>
    <script src="static/js/antispider.min.js?v=2"></script>
    <script>
        var domain = getDomain();
        window.imgCode = -1;

        (function() {
            function checkSNUID() {
                var cookieArr = document.cookie.split('; '),
                    count = 0;

                for(var i = 0, len = cookieArr.length; i < len; i++) {
                    if (cookieArr[i].indexOf('SNUID=') > -1) {
                        count++;
                    }
                }

                return count > 1;
            }

            if(checkSNUID()) {
                var date = new Date(), expires;
                date.setTime(date.getTime() -100000);

                expires = date.toGMTString();

                document.cookie = 'SNUID=1;path=/;expires=' + expires;
                document.cookie = 'SNUID=1;path=/;expires=' + expires + ';domain=.www.sogou.com';
                document.cookie = 'SNUID=1;path=/;expires=' + expires + ';domain=.weixin.sogou.com';
                document.cookie = 'SNUID=1;path=/;expires=' + expires + ';domain=.sogou.com';
                document.cookie = 'SNUID=1;path=/;expires=' + expires + ';domain=.snapshot.sogoucdn.com';

                sendLog('delSNUID');
            }

            if(getCookie('seccodeRight') === 'success') {
                sendLog('verifyLoop');

                setCookie('seccodeRight', 1, getUTCString(-1), location.hostname, '/');
            }

            if(getCookie('refresh')) {
                sendLog('refresh');
            }
        })();

        function setImgCode(code) {
            try {
                var t = new Date().getTime() - imgRequestTime.getTime();
                sendLog('imgCost',"cost="+t);
            } catch (e) {
            }
            window.imgCode = code;
        }
        sendLog('index');

        function changeImg2() {
            if(window.event) {
                window.event.returnValue=false
            }
        }
    </script>
</head>
<body>
<div class="header">
    <div class="logo"><a href="/"><img width="180" height="60" src="//www.sogou.com/images/logo2014/error180x60.png"></a></div>
    <div class="other"><span class="s1">您的访问出错了</span><span class="s2"><a href="/">返回首页&gt;&gt;</a></span></div>
</div>
<div class="content-box">
    <p class="ip-time-p">IP:183.129.218.233<br>访问时间：2016.10.27 12:41:19</p>
    <p class="p2">用户您好，您的访问过于频繁，为确认本次访问为正常用户行为，需要您协助验证。</p>
    <p class="p3"><label for="seccodeInput">验证码：</label></p>
    <form name="authform" method="POST" id="seccodeForm" action="/">
        <p class="p4">
            <input type=text name="c" value="" placeholder="请输入验证码" id="seccodeInput">
            <input type="hidden" name="tc" id="tc" value="">
            <input type="hidden" name="r" id="from" value="%2Fweb%3Fquery%3D%E6%9F%90%E8%8D%A3%26ie%3Dutf8%26_ast%3D1477536768%26_asf%3Dnull%26w%3D01029901%26cid%3D" >
            <input type="hidden" name="m" value="0" >            <span class="s1">
                <script>imgRequestTime=new Date();</script>
                <a onclick="changeImg2();" href="javascript:void(0)">
                    <img id="seccodeImage" onload="setImgCode(1)" onerror="setImgCode(0)" src="util/seccode.php?tc=1477543279" width="100" height="40" alt="请输入图中的验证码" title="请输入图中的验证码">
                </a>
            </span>
            <a href="javascript:void(0);" id="change-img" onclick="changeImg2();" style="padding-left:50px;">换一张</a>
            <span class="s2" id="error-tips" style="display: none;"></span>
        </p>
    </form>
    <p class="p5">
        <a href="javascript:void(0);" id="submit">提交</a>
        <span>提交后没解决问题？欢迎<a href="http://fankui.help.sogou.com/index.php/web/web/index?type=10&anti_time=1477543279&domain=www.sogou.com" target="_blank">反馈</a>。</span>
    </p>
</div>
<div id="ft"><a href="http://fuwu.sogou.com/" target="_blank">企业推广</a><a href="http://corp.sogou.com/" target="_blank">关于搜狗</a><a href="/docs/terms.htm?v=1" target="_blank">免责声明</a><a href="http://fankui.help.sogou.com/index.php/web/web/index?type=10&anti_time=1477543279&domain=www.sogou.com" target="_blank">意见反馈</a><br>&nbsp;&copy;&nbsp;2016<span id="footer-year"></span>&nbsp;SOGOU&nbsp;-&nbsp;<a href="http://www.miibeian.gov.cn" target="_blank" class="g">京ICP证050897号</a>&nbsp;-&nbsp;京公网安备1100<span class="ba">00000025号</span></div>
<script src="static/js/index.min.js?v=0.1.3"></script>
</body>
</html><!--zly-->
```

### 自动化生成SNUID

#### 通过访问验证码页面获取
当访问验证码页面，并填写验证码完成验证后，会重新生成一个新的SNUID，而此请求可以重复发送，每次发送都会生成一个新的SNUID。

#### 通过模拟

### 解决方案

SNUID的值如果不去使用它，可以存放很久，直到使用它到上限才会作废。









